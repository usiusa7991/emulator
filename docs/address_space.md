# アドレス空間と配列サイズ

開発中に `index out of bounds: the len is 65535 but the index is 65535` というパニックが発生しました。これは、確保されたメモリ（配列）の範囲を超えた場所にアクセスしようとしたことを示す、メモリ安全性の高い言語ならではの重要なエラーです。

## なぜ `0xFFFF` ではなく `0x10000` なのか

このエラーの直接的な原因は、`0xFFFF`（10進数で65535）というアドレスにアクセスしようとした際に、メモリを表す配列の長さも`0xFFFF`（要素数65535）しか確保されていなかったことです。

配列のインデックスは`0`から始まるため、長さが`65535`の配列の有効なインデックスは`0`から`65534`までです。インデックス`65535`は範囲外となります。

ゲームボーイのCPUは16ビットのアドレスバスを持ち、これにより `2^16` すなわち `65,536` 個のユニークなメモリアドレスを扱うことができます。このアドレスは、`0x0000`から`0xFFFF`までの範囲で表現されます。

ここで重要なのは、アドレスの「数」です。`0`から`10`までの整数が`11`個あるように、`0x0000`から`0xFFFF`までのアドレスは `0xFFFF - 0x0000 + 1` で計算され、その総数は `0x10000`（10進数で65,536）となります。

## 学び

`0x0000`から`0xFFFF`までのアドレス範囲を完全にカバーするメモリアレイを作成するには、そのサイズ（要素数）は`0x10000`でなければなりません。

-   **アドレス範囲**: `0x0000` ~ `0xFFFF`
-   **必要な要素数**: `0x10000` (65,536)
-   **配列の有効インデックス**: `0` ~ `65535` (`0xFFFF`)

このように、0から始まる範囲を扱う際は、その最大値に1を加えた数が、必要な配列のサイズになるという点は、プログラミングにおける基本的ながら非常に重要な概念です。
